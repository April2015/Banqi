var gameLogic;!function(a){function b(){return[{setTurn:{turnIndex:0}},{set:{key:"delta",value:{rowBeforeMove:-1,colBeforeMove:-1,rowAfterMove:-1,colAfterMove:-1}}},{set:{key:"b0x0",value:"R1"}},{set:{key:"b0x1",value:"R1"}},{set:{key:"b0x2",value:"R1"}},{set:{key:"b0x3",value:"R1"}},{set:{key:"b0x4",value:"R1"}},{set:{key:"b0x5",value:"R2"}},{set:{key:"b0x6",value:"R2"}},{set:{key:"b0x7",value:"R3"}},{set:{key:"b1x0",value:"R3"}},{set:{key:"b1x1",value:"R4"}},{set:{key:"b1x2",value:"R4"}},{set:{key:"b1x3",value:"R5"}},{set:{key:"b1x4",value:"R5"}},{set:{key:"b1x5",value:"R6"}},{set:{key:"b1x6",value:"R6"}},{set:{key:"b1x7",value:"R7"}},{set:{key:"b2x0",value:"B1"}},{set:{key:"b2x1",value:"B1"}},{set:{key:"b2x2",value:"B1"}},{set:{key:"b2x3",value:"B1"}},{set:{key:"b2x4",value:"B1"}},{set:{key:"b2x5",value:"B2"}},{set:{key:"b2x6",value:"B2"}},{set:{key:"b2x7",value:"B3"}},{set:{key:"b3x0",value:"B3"}},{set:{key:"b3x1",value:"B4"}},{set:{key:"b3x2",value:"B4"}},{set:{key:"b3x3",value:"B5"}},{set:{key:"b3x4",value:"B5"}},{set:{key:"b3x5",value:"B6"}},{set:{key:"b3x6",value:"B6"}},{set:{key:"b3x7",value:"B7"}},{set:{key:"stage",value:0}},{shuffle:{keys:["b0x0","b0x1","b0x2","b0x3","b0x4","b0x5","b0x6","b0x7","b1x0","b1x1","b1x2","b1x3","b1x4","b1x5","b1x6","b1x7","b2x0","b2x1","b2x2","b2x3","b2x4","b2x5","b2x6","b2x7","b3x0","b3x1","b3x2","b3x3","b3x4","b3x5","b3x6","b3x7"]}},{setVisibility:{key:"b0x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x7",visibleToPlayerIndexes:[]}}]}function c(a,b){return"b"+a.toString()+"x"+b.toString()}function d(a,b){for(var d=0,e=0,f=0;4>f;f++)for(var h=0;8>h;h++){if(null===a[c(f,h)])return"";"R"===a[c(f,h)][0]&&d++,"B"===a[c(f,h)][0]&&e++}if(0===d)return"B";if(0===e)return"R";if(angular.equals(g(a,b),[])){if(0===b)return"B";if(1===b)return"R"}return""}function e(a){for(var b=0,d=0,e=0,g=0,h=0,i=0,j=0;4>j;j++)for(var k=0;8>k;k++){if(null===a[c(j,k)])return!1;"R"===a[c(j,k)][0]&&(b++,e=j,g=k),"B"===a[c(j,k)][0]&&(d++,h=j,i=k)}if(1===b&&1===d&&!f(e,g,h,i))return!0;if(1===b&&d>1){for(var j=0;4>j;j++)for(var k=0;8>k;k++){if("B"===a[c(j,k)][0]&&a[c(e,g)][1]<a[c(j,k)][1])return!1;if("B"===a[c(j,k)][0]&&"7"===a[c(e,g)][1]&&"1"===a[c(j,k)][1])return!1;if("B"===a[c(j,k)][0]&&"2"===a[c(j,k)][1])return!1}return!0}if(1===d&&b>1){for(var j=0;4>j;j++)for(var k=0;8>k;k++){if("R"===a[c(j,k)][0]&&a[c(h,i)][1]<a[c(j,k)][1])return!1;if("R"===a[c(j,k)][0]&&"7"===a[c(e,g)][1]&&"1"===a[c(j,k)][1])return!1;if("R"===a[c(j,k)][0]&&"2"===a[c(j,k)][1])return!1}return!0}return!1}function f(a,b,c,d){return(a!==c||b-d!==1&&b-d!==-1)&&(b!==d||a-c!==1&&a-c!==-1)?!1:!0}function g(a,b){for(var c=[],d=0;4>d;d++)for(var e=0;8>e;e++)for(var f=-1;4>f;f++)for(var g=-1;8>g;g++)try{c.push(h(a,d,e,f,g,b))}catch(i){}return c}function h(a,b,d,e,f,g){if(""===a[c(b,d)])throw new Error("There is nothing at that position!");if(null===a[c(b,d)]&&(-1!==e||-1!==f))throw new Error("Can not move a unturned piece!");if(null!==a[c(b,d)]&&-1===e&&-1===f)throw new Error("This piece is already turned!");if(null!==a[c(b,d)]){if(a[c(b,d)][0]===a[c(e,f)][0])throw new Error("You can't kill yourself!");if("R"===a[c(b,d)][0]&&0!==g)throw new Error("Please wait for your turn!");if("B"===a[c(b,d)][0]&&1!==g)throw new Error("Please wait for your turn!")}if(b===e&&d===f)throw new Error("Same piece, move canceled!");var h=[];h=null===a[c(b,d)]&&-1===e&&-1===f?[{setVisibility:{key:c(b,d),visibleToPlayerIndexes:null}}]:""===a[c(e,f)]?j(a,b,d,e,f):k(a,b,d,e,f);var i=[{setTurn:{turnIndex:g}},{set:{key:"delta",value:{rowBeforeMove:b,colBeforeMove:d,rowAfterMove:e,colAfterMove:f}}},{set:{key:"stage",value:1}}];return i=i.concat(h)}function i(a,b){var c,f=d(a,1-b);return c=""!==f||e(a)?{endMatch:{endMatchScores:"R"===f?[1,0]:"B"===f?[0,1]:[0,0]}}:{setTurn:{turnIndex:1-b}},[c,{set:{key:"stage",value:0}}]}function j(a,b,d,e,g){if(f(b,d,e,g))return[{set:{key:c(e,g),value:a[c(b,d)]}},{set:{key:c(b,d),value:""}}];throw new Error("You can not move the piece to that position!")}function k(a,b,d,e,f){if(null===a[c(e,f)])throw new Error("You can not kill a unturned piece!");if("2"===a[c(b,d)][1]){if(b===e){var g,h,i=0;d>f?(g=d,h=f):(g=f,h=d);for(var k=h+1;g>k;k++)""!==a[c(e,k)]&&i++;if(1===i)return[{set:{key:c(e,f),value:a[c(b,d)]}},{set:{key:c(b,d),value:""}}]}if(d===f){var g,h,i=0;b>e?(g=b,h=e):(g=e,h=b);for(var k=h+1;g>k;k++)""!==a[c(k,f)]&&i++;if(1===i)return[{set:{key:c(e,f),value:a[c(b,d)]}},{set:{key:c(b,d),value:""}}]}throw new Error("You can not kill the piece at that position!")}if("7"===a[c(b,d)][1]&&"1"===a[c(e,f)][1])throw new Error("General can not kills soldier, soldier kills General!");if("1"===a[c(b,d)][1]&&"7"===a[c(e,f)][1])return j(a,b,d,e,f);if(a[c(b,d)][1]>=a[c(e,f)][1])return j(a,b,d,e,f);throw new Error("You can not kill the piece at that position!")}function l(a){var c=a.move,d=a.turnIndexBeforeMove,e=a.stateBeforeMove;try{var f;if(null!==e&&(f=e.stage),console.log("stage",f),0===f){var g=c[1].set.value,j=g.rowBeforeMove,k=g.colBeforeMove,l=g.rowAfterMove,m=g.colAfterMove,n=h(e,j,k,l,m,d);if(!angular.equals(c,n))return console.log("move, expectedMove are not equal"),!1}else if(1===f){var n=i(e,d);if(!angular.equals(c,n))return console.log("move, expectedMove are not equal"),!1}else{console.log("should initialGame");var n=b();if(!angular.equals(c,n))return console.log("move: ",c),console.log("expectedMove: ",n),console.log("move, expectedMove are not equal"),!1}}catch(o){return console.log("got exceptions in isMoveOk: ",o),!1}return console.log("isMoveOk is True!"),!0}a.initialGame=b,a.getPossibleMoves=g,a.createMove=h,a.checkGameEnd=i,a.isMoveOk=l}(gameLogic||(gameLogic={})),angular.module("myApp",["ngTouch","ui.bootstrap","gameServices"]).factory("gameLogic",function(){return{initialGame:gameLogic.initialGame,getPossibleMoves:gameLogic.getPossibleMoves,createMove:gameLogic.createMove,checkGameEnd:gameLogic.checkGameEnd,isMoveOk:gameLogic.isMoveOk}});var game;!function(a){function b(){console.log("Translation of 'RULES_OF_BANQI' is "+translate("RULES_OF_BANQI")),resizeGameAreaService.setWidthToHeight(2),gameService.setGame({minNumberOfPlayers:2,maxNumberOfPlayers:2,isMoveOk:gameLogic.isMoveOk,updateUI:e}),document.addEventListener("animationend",c,!1),document.addEventListener("webkitAnimationEnd",c,!1),document.addEventListener("oanimationend",c,!1),dragAndDropService.addDragListener("gameArea",f)}function c(){$rootScope.$apply(function(){log.info("Animation ended"),m=!0,d()})}function d(){if(o){o=!1;var a=aiService.createComputerMove(r,s,{millisecondsLimit:1e3});log.info("computer move: ",a),gameService.makeMove(a)}}function e(a){log.info("Game got updateUI:",a),m=!1,r=a.stateAfterMove,p=r.delta,n=a.turnIndexAfterMove>=0&&a.yourPlayerIndex===a.turnIndexAfterMove;var b;if(b=s!==a.turnIndexAfterMove?!0:!1,s=a.turnIndexAfterMove,p||!n){if(o=n&&""===a.playersInfo[a.yourPlayerIndex].playerId,o&&(n=!1,r.delta||d()),!b&&void 0!==p&&(-1!==p.rowBeforeMove||-1!==p.colBeforeMove)&&1===r.stage){log.info("delta: ",p);try{n=!1,gameService.makeMove(gameLogic.checkGameEnd(r,s))}catch(c){return log.info(c),void log.info("checkGameEnd failed!")}}if(b&&void 0!==p)if(-1!==p.rowAfterMove&&-1!==p.colAfterMove||-1===p.rowBeforeMove&&-1===p.colBeforeMove){if(-1!==p.rowBeforeMove||-1!==p.colBeforeMove){var e=p.rowAfterMove,f=p.colAfterMove,g=document.getElementById("img_"+e+"x"+f);g.className="scale1"===g.className?"scale2":"scale1"}}else{var e=p.rowBeforeMove,f=p.colBeforeMove,g=document.getElementById("img_"+e+"x"+f);g.className="slowlyAppear1"===g.className?"slowlyAppear2":"slowlyAppear1"}}else try{var h=gameLogic.initialGame();gameService.makeMove(h)}catch(c){log.info(c),log.info("initialGame() failed")}}function f(a,b,c){q=document.getElementById("gameArea");var d,e,f=b-q.offsetLeft,k=c-q.offsetTop;if(0>f||0>k||f>=q.clientWidth||k>=q.clientHeight){if(log.info("outside gameArea"),!w)return;var l=h();g({top:k-l.height/2,left:f-l.width/2})}else{var e=Math.floor(u*f/q.clientWidth),d=Math.floor(t*k/q.clientHeight);if(log.info("now at: ",d,e),"touchstart"!==a||v||(v={row:d,col:e},null!==r[aiService.key(d,e)]&&""!==r[aiService.key(d,e)]&&(0===s&&"R"===r[aiService.key(d,e)][0]||1===s&&"B"===r[aiService.key(d,e)][0])&&(w=document.getElementById("img_"+v.row+"x"+v.col))),"touchend"===a){var m=v,n={row:d,col:e};j(m,n)}else{var l=h();g({top:k-l.height/2,left:f-l.width/2})}}("touchend"===a||"touchcancel"===a||"touchleave"===a)&&(g(i(v.row,v.col)),v=null,null!==w&&(w.removeAttribute("style"),w=null))}function g(a){var b=h(),c=b.height/10,d=b.width/10,e=i(v.row,v.col);null!==w&&(w.style.left=a.left-e.left+d+"px",w.style.top=a.top-e.top+c+"px")}function h(){return{width:.96*q.clientWidth/u,height:.98*q.clientHeight/t}}function i(a,b){var c=h();return{top:a*c.height,left:b*c.width}}function j(a,b){log.info("DragDone");var c="Dragged piece "+a.row+"x"+a.col+" to square "+b.row+"x"+b.col;if(log.info(c),"?throwException"===window.location.search)throw new Error("Throwing the error because URL has '?throwException'");if(n)if(a.row===b.row&&a.col===b.col&&null===r[aiService.key(a.row,a.col)])try{var d=gameLogic.createMove(r,a.row,a.col,-1,-1,s);n=!1,gameService.makeMove(d)}catch(e){return void log.info(["Can't turn piece:",a.row,a.col,-1,-1])}else try{var d=gameLogic.createMove(r,a.row,a.col,b.row,b.col,s);n=!1,gameService.makeMove(d)}catch(e){return void log.info(["Can not move the piece:",a.row,a.col,b.row,b.col])}}function k(a,b){var c=r[aiService.key(a,b)];return""!==c}function l(a,b){var c=r[aiService.key(a,b)];return"R1"===c?"res/R1.png":"R2"===c?"res/R2.png":"R3"===c?"res/R3.png":"R4"===c?"res/R4.png":"R5"===c?"res/R5.png":"R6"===c?"res/R6.png":"R7"===c?"res/R7.png":"B1"===c?"res/B1.png":"B2"===c?"res/B2.png":"B3"===c?"res/B3.png":"B4"===c?"res/B4.png":"B5"===c?"res/B5.png":"B6"===c?"res/B6.png":"B7"===c?"res/B7.png":null===c?"res/Hide.png":""}var m=!1,n=!1,o=!1;a.isHelpModalShown=!1;var p,q,r=null,s=null,t=4,u=8,v=null,w=null;a.init=b,a.shouldShowImage=k,a.getImageSrc=l}(game||(game={})),angular.module("myApp",["ngTouch","ui.bootstrap","gameServices"]).run(function(){$rootScope.game=game,translate.setLanguage("en",{RULES_OF_BANQI:"Rules of Banqi",RULES_SLIDE1:"The ranking goes as follows: general, advisor, elephant, chariot, horse, soldier. Only pieces of equal or lower rank may be captured, with one exception. The one exception concerns generals and soldiers: the general cannot capture soldiers, and soldiers can capture the general.",RULES_SLIDE2:"Except for the cannon, pieces capture with the same motion as for movement: one square up, down, left, or right.",RULES_SLIDE3:"The cannon is not included in the ranking because it is exceptional: it captures in an unusual way, it can capture a piece of any rank, and yet is vulnerable to capture by any piece except the soldier.",RULES_SLIDE4:"A cannon captures is: moves any distance along a single row or column of the board, jumping over exactly one intermediate piece. Any other squares between the cannon and its target must be empty. Since a cannon must jump to capture, it cannot capture a piece in an adjacent square.",RULES_SLIDE5:"Red has the 1st move. The player killed all pieces in other side win the game.",CLOSE:"Close"}),game.init()});var aiService;!function(a){function b(a,b){for(var e=gameLogic.getPossibleMoves(a,b),g=[],h=[],i=[],j=[],k=[],l=e,m=0;m<e.length;m++){var n=e[m][1].set.value;-1!==n.rowAfterMove||-1!==n.colAfterMove?""!==a[c(n.rowAfterMove,n.colAfterMove)]?d(a,n.rowBeforeMove,n.colBeforeMove,n.rowAfterMove,n.colAfterMove)?h.push(e[m]):g.push(e[m]):(!d(a,n.rowBeforeMove,n.colBeforeMove,n.rowAfterMove,n.colAfterMove)&&f(a,n.rowBeforeMove,n.colBeforeMove,n.rowAfterMove,n.colAfterMove)&&i.push(e[m]),!d(a,n.rowBeforeMove,n.colBeforeMove,n.rowAfterMove,n.colAfterMove)&&d(a,n.rowBeforeMove,n.colBeforeMove,n.rowBeforeMove,n.colBeforeMove)?i.push(e[m]):d(a,n.rowBeforeMove,n.colBeforeMove,n.rowAfterMove,n.colAfterMove)?k.push(e[m]):j.push(e[m])):j.push(e[m])}return angular.equals(g,[])?angular.equals(h,[])?angular.equals(i,[])?angular.equals(j,[])?angular.equals(k,[])?angular.equals(l,[])?void 0:l[Math.floor(Math.random()*l.length)]:k[Math.floor(Math.random()*k.length)]:j[Math.floor(Math.random()*j.length)]:i[Math.floor(Math.random()*i.length)]:h[Math.floor(Math.random()*h.length)]:g[Math.floor(Math.random()*g.length)]}function c(a,b){return"b"+a.toString()+"x"+b.toString()}function d(a,b,d,f,g){if(f-1>=0&&null!==a[c(f-1,g)]&&a[c(f-1,g)][0]!==a[c(b,d)][0]&&(a[c(f-1,g)][1]>=a[c(b,d)][1]&&("7"!==a[c(f-1,g)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f-1,g)][1]||"1"===a[c(f-1,g)][1]&&"7"===a[c(b,d)][1]))return!0;if(g-1>=0&&null!==a[c(f,g-1)]&&a[c(f,g-1)][0]!==a[c(b,d)][0]&&(a[c(f,g-1)][1]>=a[c(b,d)][1]&&("7"!==a[c(f,g-1)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f,g-1)][1]||"1"===a[c(f,g-1)][1]&&"7"===a[c(b,d)][1]))return!0;if(3>=f+1&&null!==a[c(f+1,g)]&&a[c(f+1,g)][0]!==a[c(b,d)][0]&&(a[c(f+1,g)][1]>=a[c(b,d)][1]&&("7"!==a[c(f+1,g)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f+1,g)][1]||"1"===a[c(f+1,g)][1]&&"7"===a[c(b,d)][1]))return!0;if(7>=g+1&&null!==a[c(f,g+1)]&&a[c(f,g+1)][0]!==a[c(b,d)][0]&&(a[c(f,g+1)][1]>=a[c(b,d)][1]&&("7"!==a[c(f,g+1)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f,g+1)][1]||"1"===a[c(f,g+1)][1]&&"7"===a[c(b,d)][1]))return!0;var h;"R"===a[c(b,d)][0]&&(h="B2"),"B"===a[c(b,d)][0]&&(h="R2");for(var i=0;4>i;i++)for(var j=0;8>j;j++)if(a[c(i,j)]===h&&e(a,i,j,f,g))return!0;return!1}function e(a,b,d,e,f){if(b===e){var g,h,i=0;d>f?(g=d,h=f):(g=f,h=d);for(var j=h+1;g>j;j++)""!==a[c(e,j)]&&i++;if(1===i)return!0}if(d===f){var g,h,i=0;b>e?(g=b,h=e):(g=e,h=b);for(var j=h+1;g>j;j++)""!==a[c(j,f)]&&i++;if(1===i)return!0}return!1}function f(a,b,d,e,f){return e-1>=0&&null!==a[c(e-1,f)]&&a[c(e-1,f)][0]!==a[c(b,d)][0]&&(a[c(e-1,f)][1]<a[c(b,d)][1]&&("1"!==a[c(e-1,f)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e-1,f)][1]&&"1"===a[c(b,d)][1])?!0:f-1>=0&&null!==a[c(e,f-1)]&&a[c(e,f-1)][0]!==a[c(b,d)][0]&&(a[c(e,f-1)][1]<a[c(b,d)][1]&&("1"!==a[c(e,f-1)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e,f-1)][1]&&"1"===a[c(b,d)][1])?!0:3>=e+1&&null!==a[c(e+1,f)]&&a[c(e+1,f)][0]!==a[c(b,d)][0]&&(a[c(e+1,f)][1]<a[c(b,d)][1]&&("1"!==a[c(e+1,f)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e+1,f)][1]&&"1"===a[c(b,d)][1])?!0:7>=f+1&&null!==a[c(e,f+1)]&&a[c(e,f+1)][0]!==a[c(b,d)][0]&&(a[c(e,f+1)][1]<a[c(b,d)][1]&&("1"!==a[c(e,f+1)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e,f+1)][1]&&"1"===a[c(b,d)][1])?!0:!1}a.createComputerMove=b,a.key=c}(aiService||(aiService={})),angular.module("myApp").factory("aiService",function(){return{createComputerMove:aiService.createComputerMove}});
//# sourceMappingURL=everything.min.js.map