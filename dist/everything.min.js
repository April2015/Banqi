angular.module("myApp",["ngTouch","ui.bootstrap"]).factory("gameLogic",function(){"use strict";function a(){return[{setTurn:{turnIndex:0}},{set:{key:"delta",value:{rowBeforeMove:-1,colBeforeMove:-1,rowAfterMove:-1,colAfterMove:-1}}},{set:{key:"b0x0",value:"R1"}},{set:{key:"b0x1",value:"R1"}},{set:{key:"b0x2",value:"R1"}},{set:{key:"b0x3",value:"R1"}},{set:{key:"b0x4",value:"R1"}},{set:{key:"b0x5",value:"R2"}},{set:{key:"b0x6",value:"R2"}},{set:{key:"b0x7",value:"R3"}},{set:{key:"b1x0",value:"R3"}},{set:{key:"b1x1",value:"R4"}},{set:{key:"b1x2",value:"R4"}},{set:{key:"b1x3",value:"R5"}},{set:{key:"b1x4",value:"R5"}},{set:{key:"b1x5",value:"R6"}},{set:{key:"b1x6",value:"R6"}},{set:{key:"b1x7",value:"R7"}},{set:{key:"b2x0",value:"B1"}},{set:{key:"b2x1",value:"B1"}},{set:{key:"b2x2",value:"B1"}},{set:{key:"b2x3",value:"B1"}},{set:{key:"b2x4",value:"B1"}},{set:{key:"b2x5",value:"B2"}},{set:{key:"b2x6",value:"B2"}},{set:{key:"b2x7",value:"B3"}},{set:{key:"b3x0",value:"B3"}},{set:{key:"b3x1",value:"B4"}},{set:{key:"b3x2",value:"B4"}},{set:{key:"b3x3",value:"B5"}},{set:{key:"b3x4",value:"B5"}},{set:{key:"b3x5",value:"B6"}},{set:{key:"b3x6",value:"B6"}},{set:{key:"b3x7",value:"B7"}},{set:{key:"stage",value:0}},{shuffle:{keys:["b0x0","b0x1","b0x2","b0x3","b0x4","b0x5","b0x6","b0x7","b1x0","b1x1","b1x2","b1x3","b1x4","b1x5","b1x6","b1x7","b2x0","b2x1","b2x2","b2x3","b2x4","b2x5","b2x6","b2x7","b3x0","b3x1","b3x2","b3x3","b3x4","b3x5","b3x6","b3x7"]}},{setVisibility:{key:"b0x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b0x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b1x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b2x7",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x0",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x1",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x2",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x3",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x4",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x5",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x6",visibleToPlayerIndexes:[]}},{setVisibility:{key:"b3x7",visibleToPlayerIndexes:[]}}]}function b(a,b){return"b"+a.toString()+"x"+b.toString()}function c(a,c){for(var d=0,e=0,g=0;4>g;g++)for(var h=0;8>h;h++){if(null===a[b(g,h)])return"";"R"===a[b(g,h)][0]&&d++,"B"===a[b(g,h)][0]&&e++}if(0===d)return"B";if(0===e)return"R";if(angular.equals(f(a,c),[])){if(0===c)return"B";if(1===c)return"R"}return""}function d(a){for(var c=0,d=0,f=0,g=0,h=0,i=0,j=0;4>j;j++)for(var k=0;8>k;k++){if(null===a[b(j,k)])return!1;"R"===a[b(j,k)][0]&&(c++,f=j,g=k),"B"===a[b(j,k)][0]&&(d++,h=j,i=k)}if(1===c&&1===d&&!e(f,g,h,i))return!0;if(1===c&&d>1){for(var j=0;4>j;j++)for(var k=0;8>k;k++){if("B"===a[b(j,k)][0]&&a[b(f,g)][1]<a[b(j,k)][1])return!1;if("B"===a[b(j,k)][0]&&"7"===a[b(f,g)][1]&&"1"===a[b(j,k)][1])return!1;if("B"===a[b(j,k)][0]&&"2"===a[b(j,k)][1])return!1}return!0}if(1===d&&c>1){for(var j=0;4>j;j++)for(var k=0;8>k;k++){if("R"===a[b(j,k)][0]&&a[b(h,i)][1]<a[b(j,k)][1])return!1;if("R"===a[b(j,k)][0]&&"7"===a[b(f,g)][1]&&"1"===a[b(j,k)][1])return!1;if("R"===a[b(j,k)][0]&&"2"===a[b(j,k)][1])return!1}return!0}return!1}function e(a,b,c,d){return(a!==c||b-d!==1&&b-d!==-1)&&(b!==d||a-c!==1&&a-c!==-1)?!1:!0}function f(a,b){var c,d,e,f,h=[];for(c=0;4>c;c++)for(d=0;8>d;d++)for(e=-1;4>e;e++)for(f=-1;8>f;f++)try{h.push(g(a,c,d,e,f,b))}catch(i){}return h}function g(a,c,d,e,f,g){if(""===a[b(c,d)])throw new Error("There is nothing at that position!");if(null===a[b(c,d)]&&(-1!==e||-1!==f))throw new Error("Can not move a unturned piece!");if(null!==a[b(c,d)]&&-1===e&&-1===f)throw new Error("This piece is already turned!");if(null!==a[b(c,d)]){if(a[b(c,d)][0]===a[b(e,f)][0])throw new Error("You can't kill yourself!");if("R"===a[b(c,d)][0]&&0!==g)throw new Error("Please wait for your turn!");if("B"===a[b(c,d)][0]&&1!==g)throw new Error("Please wait for your turn!")}if(c===e&&d===f)throw new Error("Same piece, move canceled!");var h;return h=null===a[b(c,d)]&&-1===e&&-1===f?[{setVisibility:{key:b(c,d),visibleToPlayerIndexes:null}}]:""===a[b(e,f)]?i(a,c,d,e,f):j(a,c,d,e,f),[{setTurn:{turnIndex:g}},{set:{key:"delta",value:{rowBeforeMove:c,colBeforeMove:d,rowAfterMove:e,colAfterMove:f}}},{set:{key:"stage",value:1}}].concat(h)}function h(a,b){var e,f=c(a,1-b);return e=""!==f||d(a)?{endMatch:{endMatchScores:"R"===f?[1,0]:"B"===f?[0,1]:[0,0]}}:{setTurn:{turnIndex:1-b}},[e,{set:{key:"stage",value:0}}]}function i(a,c,d,f,g){if(e(c,d,f,g))return[{set:{key:b(f,g),value:a[b(c,d)]}},{set:{key:b(c,d),value:""}}];throw new Error("You can not move the piece to that position!")}function j(a,c,d,e,f){if(null===a[b(e,f)])throw new Error("You can not kill a unturned piece!");if("2"===a[b(c,d)][1]){if(c===e){var g,h,j=0;d>f?(g=d,h=f):(g=f,h=d);for(var k=h+1;g>k;k++)""!==a[b(e,k)]&&j++;if(1===j)return[{set:{key:b(e,f),value:a[b(c,d)]}},{set:{key:b(c,d),value:""}}]}if(d===f){var g,h,j=0;c>e?(g=c,h=e):(g=e,h=c);for(var k=h+1;g>k;k++)""!==a[b(k,f)]&&j++;if(1===j)return[{set:{key:b(e,f),value:a[b(c,d)]}},{set:{key:b(c,d),value:""}}]}throw new Error("You can not kill the piece at that position!")}if("7"===a[b(c,d)][1]&&"1"===a[b(e,f)][1])throw new Error("General can not kills soldier, soldier kills General!");if("1"===a[b(c,d)][1]&&"7"===a[b(e,f)][1])return i(a,c,d,e,f);if(a[b(c,d)][1]>=a[b(e,f)][1])return i(a,c,d,e,f);throw new Error("You can not kill the piece at that position!")}function k(b){var c=b.move,d=b.turnIndexBeforeMove,e=b.stateBeforeMove;try{var f;if(null!==e&&(f=e.stage),console.log("stage",f),0===f){var i=c[1].set.value,j=i.rowBeforeMove,k=i.colBeforeMove,l=i.rowAfterMove,m=i.colAfterMove,n=g(e,j,k,l,m,d);if(!angular.equals(c,n))return console.log("move, expectedMove are not equal"),!1}else if(1===f){var n=h(e,d);if(!angular.equals(c,n))return console.log("move, expectedMove are not equal"),!1}else{console.log("should initialGame");var n=a();if(!angular.equals(c,n))return console.log("move: ",c),console.log("expectedMove: ",n),console.log("move, expectedMove are not equal"),!1}}catch(o){return console.log("got exceptions in isMoveOk: ",o),!1}return console.log("isMoveOk is True!"),!0}return{initialGame:a,getPossibleMoves:f,createMove:g,checkGameEnd:h,isMoveOk:k}}),angular.module("myApp").controller("Ctrl",["$scope","$log","$timeout","$rootScope","$translate","gameService","stateService","gameLogic","aiService","resizeGameAreaService","dragAndDropService",function(a,b,c,d,e,f,g,h,i,j,k){"use strict";function l(b,c,d){var e,f,g=c-v.offsetLeft,h=d-v.offsetTop;if(0>g||0>h||g>=v.clientWidth||h>=v.clientHeight){if(console.log("outside gameArea"),!z)return;var i=n();m({top:h-i.height/2,left:g-i.width/2})}else{var f=Math.floor(x*g/v.clientWidth),e=Math.floor(w*h/v.clientHeight);if(console.log("now at: ",e,f),"touchstart"!==b||y||(y={row:e,col:f},null!==a.stateAfterMove[t(e,f)]&&""!==a.stateAfterMove[t(e,f)]&&(0===a.turnIndex&&"R"===a.stateAfterMove[t(e,f)][0]||1===a.turnIndex&&"B"===a.stateAfterMove[t(e,f)][0])&&(z=document.getElementById("img_"+y.row+"x"+y.col))),"touchend"===b){var j=y,k={row:e,col:f};p(j,k)}else{var i=n();m({top:h-i.height/2,left:g-i.width/2})}}("touchend"===b||"touchcancel"===b||"touchleave"===b)&&(m(o(y.row,y.col)),y=null,null!==z&&(z.removeAttribute("style"),z=null))}function m(a){var b=n(),c=b.height/10,d=b.width/10,e=o(y.row,y.col);null!==z&&(z.style.left=a.left-e.left+d+"px",z.style.top=a.top-e.top+c+"px")}function n(){return{width:.96*v.clientWidth/x,height:.98*v.clientHeight/w}}function o(a,b){var c=n();return{top:a*c.height,left:b*c.width}}function p(c,e){console.log("DragDone"),d.$apply(function(){var d="Dragged piece "+c.row+"x"+c.col+" to square "+e.row+"x"+e.col;if(console.log(d),a.isYourTurn)if(c.row===e.row&&c.col===e.col&&null===a.stateAfterMove[t(c.row,c.col)])try{var g=h.createMove(a.stateAfterMove,c.row,c.col,-1,-1,a.turnIndex);a.isYourTurn=!1,f.makeMove(g)}catch(i){return void b.info(["Can't turn piece:",c.row,c.col,-1,-1])}else try{var g=h.createMove(a.stateAfterMove,c.row,c.col,e.row,e.col,a.turnIndex);a.isYourTurn=!1,f.makeMove(g)}catch(i){return void b.info(["Can not move the piece:",c.row,c.col,e.row,e.col])}})}function q(a){for(var b=[],c=0;a>c;c++)b.push(c);return b}function r(){var b=i.createComputerMove(a.stateAfterMove,a.turnIndex,{millisecondsLimit:1e3});console.log("computer move: ",b),f.makeMove(b)}function s(d){a.stateAfterMove=d.stateAfterMove,a.delta=d.stateAfterMove.delta,a.isYourTurn=d.turnIndexAfterMove>=0&&d.yourPlayerIndex===d.turnIndexAfterMove;var e;if(e=a.turnIndex!==d.turnIndexAfterMove?!0:!1,a.turnIndex=d.turnIndexAfterMove,!a.delta&&a.isYourTurn)return void u();if(1!==A&&a.isYourTurn&&""===d.playersInfo[d.yourPlayerIndex].playerId?(A=1,a.isYourTurn=!1,c(r,1e3)):A=0,!e&&void 0!==a.delta&&(-1!==a.delta.rowBeforeMove||-1!==a.delta.colBeforeMove)&&1===a.stateAfterMove.stage){console.log("delta: ",a.delta);try{var g=h.checkGameEnd(a.stateAfterMove,a.turnIndex);a.isYourTurn=!1,f.makeMove(g)}catch(i){return b.info(i),void b.info("checkGameEnd failed!")}}if(e&&void 0!==a.delta)if(-1!==a.delta.rowAfterMove&&-1!==a.delta.colAfterMove||-1===a.delta.rowBeforeMove&&-1===a.delta.colBeforeMove){if(-1!==a.delta.rowBeforeMove||-1!==a.delta.colBeforeMove){var j=a.delta.rowAfterMove,k=a.delta.colAfterMove,l=document.getElementById("img_"+j+"x"+k);l.className="scale1"===l.className?"scale2":"scale1"}}else{var j=a.delta.rowBeforeMove,k=a.delta.colBeforeMove,l=document.getElementById("img_"+j+"x"+k);l.className="slowlyAppear1"===l.className?"slowlyAppear2":"slowlyAppear1"}}function t(a,b){return"b"+a.toString()+"x"+b.toString()}function u(){try{var a=h.initialGame();f.makeMove(a)}catch(c){return b.info(c),void b.info("initialGame() failed")}}var v=document.getElementById("gameArea"),w=4,x=8,y=null,z=null;k.addDragListener("gameArea",l),console.log("Translation of 'RULES_OF_BANQI' is "+e("RULES_OF_BANQI")),window.e2e_test_stateService=g,j.setWidthToHeight(2),a.rows=q(w),a.cols=q(x),a.rowsNum=w,a.colsNum=x;var A=0;f.setGame({gameDeveloperEmail:"xiaodongbo627@gmail.com",minNumberOfPlayers:2,maxNumberOfPlayers:2,isMoveOk:h.isMoveOk,updateUI:s}),a.shouldShowImage=function(b,c){var d=a.stateAfterMove[t(b,c)];return""!==d},a.getImageSrc=function(b,c){var d=a.stateAfterMove[t(b,c)];return"R1"===d?"res/R1.png":"R2"===d?"res/R2.png":"R3"===d?"res/R3.png":"R4"===d?"res/R4.png":"R5"===d?"res/R5.png":"R6"===d?"res/R6.png":"R7"===d?"res/R7.png":"B1"===d?"res/B1.png":"B2"===d?"res/B2.png":"B3"===d?"res/B3.png":"B4"===d?"res/B4.png":"B5"===d?"res/B5.png":"B6"===d?"res/B6.png":"B7"===d?"res/B7.png":null===d?"res/Hide.png":""}}]),angular.module("myApp").factory("aiService",["gameLogic",function(a){"use strict";function b(b,e){for(var g=a.getPossibleMoves(b,e),h=[],i=[],j=[],k=[],l=[],m=g,n=0;n<g.length;n++){var o=g[n][1].set.value;-1!==o.rowAfterMove||-1!==o.colAfterMove?""!==b[c(o.rowAfterMove,o.colAfterMove)]?d(b,o.rowBeforeMove,o.colBeforeMove,o.rowAfterMove,o.colAfterMove)?i.push(g[n]):h.push(g[n]):(!d(b,o.rowBeforeMove,o.colBeforeMove,o.rowAfterMove,o.colAfterMove)&&f(b,o.rowBeforeMove,o.colBeforeMove,o.rowAfterMove,o.colAfterMove)&&j.push(g[n]),!d(b,o.rowBeforeMove,o.colBeforeMove,o.rowAfterMove,o.colAfterMove)&&d(b,o.rowBeforeMove,o.colBeforeMove,o.rowBeforeMove,o.colBeforeMove)?j.push(g[n]):d(b,o.rowBeforeMove,o.colBeforeMove,o.rowAfterMove,o.colAfterMove)?l.push(g[n]):k.push(g[n])):k.push(g[n])}return angular.equals(h,[])?angular.equals(i,[])?angular.equals(j,[])?angular.equals(k,[])?angular.equals(l,[])?angular.equals(m,[])?void 0:m[Math.floor(Math.random()*m.length)]:l[Math.floor(Math.random()*l.length)]:k[Math.floor(Math.random()*k.length)]:j[Math.floor(Math.random()*j.length)]:i[Math.floor(Math.random()*i.length)]:h[Math.floor(Math.random()*h.length)]}function c(a,b){return"b"+a.toString()+"x"+b.toString()}function d(a,b,d,f,g){if(f-1>=0&&null!==a[c(f-1,g)]&&a[c(f-1,g)][0]!==a[c(b,d)][0]&&(a[c(f-1,g)][1]>=a[c(b,d)][1]&&("7"!==a[c(f-1,g)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f-1,g)][1]||"1"===a[c(f-1,g)][1]&&"7"===a[c(b,d)][1]))return!0;if(g-1>=0&&null!==a[c(f,g-1)]&&a[c(f,g-1)][0]!==a[c(b,d)][0]&&(a[c(f,g-1)][1]>=a[c(b,d)][1]&&("7"!==a[c(f,g-1)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f,g-1)][1]||"1"===a[c(f,g-1)][1]&&"7"===a[c(b,d)][1]))return!0;if(3>=f+1&&null!==a[c(f+1,g)]&&a[c(f+1,g)][0]!==a[c(b,d)][0]&&(a[c(f+1,g)][1]>=a[c(b,d)][1]&&("7"!==a[c(f+1,g)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f+1,g)][1]||"1"===a[c(f+1,g)][1]&&"7"===a[c(b,d)][1]))return!0;if(7>=g+1&&null!==a[c(f,g+1)]&&a[c(f,g+1)][0]!==a[c(b,d)][0]&&(a[c(f,g+1)][1]>=a[c(b,d)][1]&&("7"!==a[c(f,g+1)][1]||"1"!==a[c(b,d)][1])&&"2"!==a[c(f,g+1)][1]||"1"===a[c(f,g+1)][1]&&"7"===a[c(b,d)][1]))return!0;var h;"R"===a[c(b,d)][0]&&(h="B2"),"B"===a[c(b,d)][0]&&(h="R2");for(var i=0;4>i;i++)for(var j=0;8>j;j++)if(a[c(i,j)]===h&&e(a,i,j,f,g))return!0;return!1}function e(a,b,d,e,f){if(b===e){var g,h,i=0;d>f?(g=d,h=f):(g=f,h=d);for(var j=h+1;g>j;j++)""!==a[c(e,j)]&&i++;if(1===i)return!0}if(d===f){var g,h,i=0;b>e?(g=b,h=e):(g=e,h=b);for(var j=h+1;g>j;j++)""!==a[c(j,f)]&&i++;if(1===i)return!0}return!1}function f(a,b,d,e,f){return e-1>=0&&null!==a[c(e-1,f)]&&a[c(e-1,f)][0]!==a[c(b,d)][0]&&(a[c(e-1,f)][1]<a[c(b,d)][1]&&("1"!==a[c(e-1,f)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e-1,f)][1]&&"1"===a[c(b,d)][1])?!0:f-1>=0&&null!==a[c(e,f-1)]&&a[c(e,f-1)][0]!==a[c(b,d)][0]&&(a[c(e,f-1)][1]<a[c(b,d)][1]&&("1"!==a[c(e,f-1)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e,f-1)][1]&&"1"===a[c(b,d)][1])?!0:3>=e+1&&null!==a[c(e+1,f)]&&a[c(e+1,f)][0]!==a[c(b,d)][0]&&(a[c(e+1,f)][1]<a[c(b,d)][1]&&("1"!==a[c(e+1,f)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e+1,f)][1]&&"1"===a[c(b,d)][1])?!0:7>=f+1&&null!==a[c(e,f+1)]&&a[c(e,f+1)][0]!==a[c(b,d)][0]&&(a[c(e,f+1)][1]<a[c(b,d)][1]&&("1"!==a[c(e,f+1)][1]||"7"!==a[c(b,d)][1])&&"2"!==a[c(b,d)][1]||"7"===a[c(e,f+1)][1]&&"1"===a[c(b,d)][1])?!0:!1}return{createComputerMove:b}}]);
//# sourceMappingURL=everything.min.js.map